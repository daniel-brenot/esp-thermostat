import { VerticalBox, Slider, HorizontalBox } from "std-widgets.slint";

export component MainWindow inherits Window {
    width: 320px;
    height: 240px;
    background: #333;

    // All temperatures stored in Celsius (base unit)
    in-out property<float> current-temp-c: 26.7;  // ~80°F
    in-out property<float> target-temp-c: 21.7;   // ~71°F
    property<bool> showing-target-temp: false;
    in-out property<bool> use-fahrenheit: true;
    in-out property<string> thermostat-state: "INITIALIZING";
    
    // Temperature range constants (in Celsius)
    property<float> temp-min-c: 15.0;   // ~59°F
    property<float> temp-max-c: 27.0;   // ~81°F
    
    
    
    // Fan mode: 0 = Auto, 1 = On
    in-out property<int> fan-mode: 0;
    // HVAC mode: 0 = Heat, 1 = Cool, 2 = Off
    in-out property<int> hvac-mode: 2;
    // Diff mode: 0 = Slow, 1 = Normal, 2 = Fast
    in-out property<int> diff-mode: 1;
    // Rest mode: 0 = SHORT, 1 = Med, 2 = LONG, 3 = Off
    in-out property<int> rest-mode: 3;

    callback target-temp-changed(float);
    callback fan-mode-changed(int);
    callback hvac-mode-changed(int);
    callback diff-mode-changed(int);
    callback rest-mode-changed(int);
    
    // Helper functions to convert temperature
    function f-to-c(f: float) -> float {
        return (f - 32.0) * 5.0 / 9.0;
    }
    
    function c-to-f(c: float) -> float {
        return (c * 9.0 / 5.0) + 32.0;
    }
    
    function f-to-c-display(f: float) -> float {
        return floor(((f - 32.0) * 5.0 / 9.0) * 10.0 + 0.5) / 10.0;
    }
    
    function c-to-f-display(c: float) -> float {
        return floor(((c * 9.0 / 5.0) + 32.0) * 10.0 + 0.5) / 10.0;
    }
    
    // Normalize target-temp-c to 0-1 range for slider
    function temp-c-to-normalized(c: float) -> float {
        return (c - temp-min-c) / (temp-max-c - temp-min-c);
    }
    
    // Convert normalized slider value back to Celsius
    function normalized-to-temp-c(n: float) -> float {
        return n * (temp-max-c - temp-min-c) + temp-min-c;
    }
    

    timer := Timer {
        interval: 5s;
        running: false;
        triggered => {
            showing-target-temp = false;
        }
    }
    
    // Animation for pulsing state label
    property<float> pulse-opacity: 1.0;
    property<bool> pulse-direction: false;
    
    pulse-timer := Timer {
        interval: 50ms;
        running: true;
        triggered => {
            if (pulse-direction) {
                pulse-opacity = pulse-opacity + 0.05;
                if (pulse-opacity >= 1.0) {
                    pulse-opacity = 1.0;
                    pulse-direction = false;
                }
            } else {
                pulse-opacity = pulse-opacity - 0.05;
                if (pulse-opacity <= 0.6) {
                    pulse-opacity = 0.6;
                    pulse-direction = true;
                }
            }
            pulse-timer.running = true;
        }
    }

    VerticalBox {
        
        // Thermostat State Label
        Text {
            text: thermostat-state;
            font-size: 25px;
            opacity: pulse-opacity;
            color: {
                thermostat-state == "Heating" ? #FF6B6B :
                thermostat-state == "Cooling" ? #2E86AB :
                thermostat-state == "Resting" ? #6B8E9F :
                #AAA
            }
            horizontal-alignment: center;
        }
        
        VerticalBox {
            alignment: center;
            padding: 0px;
            spacing: 1px;
            
            // Current Temperature Display
            HorizontalBox {
                spacing: 6px;
                alignment: LayoutAlignment.space-between;
                
                Text {
                    text: "Current temp:";
                    vertical-alignment: TextVerticalAlignment.center;
                    color: #AAA;
                    font-size: 18px;
                    horizontal-alignment: left;
                }
                
                Text {
                    // Base unit is Celsius, convert to Fahrenheit if needed (2 decimal places)
                    text: "\{floor((use-fahrenheit ? c-to-f(current-temp-c) : current-temp-c) * 100.0 + 0.5) / 100.0}\{use-fahrenheit ? "°F" : "°C"}";
                    vertical-alignment: TextVerticalAlignment.center;
                    font-size: 20px;
                    color: white;
                    horizontal-alignment: TextHorizontalAlignment.right;
                }
            }
            
            // Target Temperature Display
            HorizontalBox {
                spacing: 6px;
                alignment: LayoutAlignment.space-between;
                
                Text {
                    text: "Target temp:";
                    vertical-alignment: TextVerticalAlignment.center;
                    color: #AAA;
                    font-size: 18px;
                    horizontal-alignment: left;
                }
                
                Text {
                    // Base unit is Celsius, convert to Fahrenheit if needed
                    text: "\{floor((use-fahrenheit ? c-to-f(target-temp-c) : target-temp-c) + 0.5)}\{use-fahrenheit ? "°F" : "°C"}";
                    vertical-alignment: TextVerticalAlignment.center;
                    font-size: 20px;
                    color: showing-target-temp ? #4CAF50 : white;
                    horizontal-alignment: TextHorizontalAlignment.right;
                }
            }
        }
        
        // Target Temperature Slider - uses normalized 0-1 range to avoid clamping issues when switching units
        Slider {
            minimum: 0.0;
            maximum: 1.0;
            value: temp-c-to-normalized(target-temp-c);
            width: 300px;
            height: 25px;
            
            changed(value) => {
                target-temp-c = normalized-to-temp-c(value);
                showing-target-temp = true;
                timer.running = false;
                timer.running = true;
                target-temp-changed(target-temp-c);
            }
        }

        // Control buttons
        HorizontalBox {
            alignment: LayoutAlignment.space-between;
            padding: 0px;
            
            // HVAC Mode Toggle (bottom left)
            VerticalBox {
                alignment: start;
                padding: 0px;
                
                Text {
                    text: "MODE";
                    color: #AAA;
                    font-size: 10px;
                    horizontal-alignment: center;
                }
                
                Rectangle {
                    width: 55px;
                    height: 24px;
                    background: hvac-mode == 0 ? #FF6B6B : (hvac-mode == 1 ? #2E86AB : #666);
                    border-radius: 4px;
                    
                    Text {
                        text: hvac-mode == 0 ? "HEAT" : (hvac-mode == 1 ? "COOL" : "OFF");
                        color: white;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        clicked => {
                            hvac-mode = Math.mod(hvac-mode + 1, 3);
                            hvac-mode-changed(hvac-mode);
                        }
                    }
                }
            }
            
            // Temperature Unit Toggle (middle bottom)
            VerticalBox {
                alignment: center;
                padding: 0px;
                
                Text {
                    text: "UNIT";
                    color: #AAA;
                    font-size: 10px;
                    horizontal-alignment: center;
                }
                
                Rectangle {
                    width: 55px;
                    height: 24px;
                    background: use-fahrenheit ? #E2A04A : #4A90E2;
                    border-radius: 4px;
                    
                    Text {
                        text: use-fahrenheit ? "°F" : "°C";
                        color: white;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        clicked => {
                            use-fahrenheit = !use-fahrenheit;
                        }
                    }
                }
            }
            
            // Diff Mode Toggle (middle-right)
            VerticalBox {
                alignment: center;
                padding: 0px;
                
                Text {
                    text: "DIFF";
                    color: #AAA;
                    font-size: 10px;
                    horizontal-alignment: center;
                }
                
                Rectangle {
                    width: 55px;
                    height: 24px;
                    background: diff-mode == 0 ? #9B59B6 : (diff-mode == 1 ? #3498DB : #E67E22);
                    border-radius: 4px;
                    
                    Text {
                        text: diff-mode == 0 ? "SLOW" : (diff-mode == 1 ? "NORM" : "FAST");
                        color: white;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        clicked => {
                            diff-mode = Math.mod(diff-mode + 1, 3);
                            diff-mode-changed(diff-mode);
                        }
                    }
                }
            }
            
            // Rest Mode Toggle
            VerticalBox {
                alignment: center;
                padding: 0px;
                
                Text {
                    text: "REST";
                    color: #AAA;
                    font-size: 10px;
                    horizontal-alignment: center;
                }
                
                Rectangle {
                    width: 55px;
                    height: 24px;
                    background: rest-mode == 0 ? #8B6F47 : (rest-mode == 1 ? #A67C52 : (rest-mode == 2 ? #8B7355 : #555));
                    border-radius: 4px;
                    
                    Text {
                        text: rest-mode == 0 ? "SHORT" : (rest-mode == 1 ? "MED" : (rest-mode == 2 ? "LONG" : "OFF"));
                        color: white;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        clicked => {
                            rest-mode = Math.mod(rest-mode + 1, 4);
                            rest-mode-changed(rest-mode);
                        }
                    }
                }
            }
            
            // Fan Mode Toggle (bottom right) - Auto or On only
            VerticalBox {
                alignment: center;
                padding: 0px;
                
                Text {
                    text: "FAN";
                    color: #AAA;
                    font-size: 10px;
                    horizontal-alignment: center;
                }
                
                Rectangle {
                    width: 55px;
                    height: 24px;
                    background: fan-mode == 0 ? #6B8E9F : #C97D60;
                    border-radius: 4px;
                    
                    Text {
                        text: fan-mode == 0 ? "AUTO" : "ON";
                        color: white;
                        font-size: 12px;
                        horizontal-alignment: center;
                        vertical-alignment: center;
                    }
                    
                    TouchArea {
                        clicked => {
                            fan-mode = Math.mod(fan-mode + 1, 2);
                            fan-mode-changed(fan-mode);
                        }
                    }
                }
            }
        }
    }
}